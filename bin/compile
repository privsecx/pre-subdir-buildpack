#!/usr/bin/env bash

# Usage: bin/compile BUILD_DIR CACHE_DIR ENV_DIR

set -euo pipefail

# Detect requirements and fail if not met.
# Note: we can't do this in bin/detect script
# as we don't have access to env vars there.

build_dir=$1
env_dir=$3

failed=false
for env_var in FRONTEND_BUILDPACK_JS_APP FRONTEND_BUILDPACK_JS_ROUTE FRONTEND_BUILDPACK_RAILS_APP; do
  if [[ -f "${env_dir}/${env_var}" ]]; then
    export ${env_var}="$(cat ${env_dir}/${env_var})"
  else
    echo "FATAL: Please set env var: ${env_var}"
    failed=true
  fi
done

if [ $failed = true ]; then
  exit 1
fi

js_app="${build_dir}/${FRONTEND_BUILDPACK_JS_APP}"
js_route="${FRONTEND_BUILDPACK_JS_ROUTE}"
rails_app="${build_dir}/${FRONTEND_BUILDPACK_RAILS_APP}"

js_app_requirement=$js_app/package.json
if [[ ! -f ${js_app_requirement} ]]; then
  echo "FATAL: Missing expected file: ${js_app_requirement}"
  failed=true
fi

js_app_copy="${rails_app}/frontends/raw/${js_route}"
if [[ -e $js_app_copy ]]; then
  echo "FATAL: Unexpected: $js_app_copy already exists"
  failed=true
fi

if [ $failed = true ]; then
  exit 1
fi

# Requirements are met; proceed with main actions:

set +x
echo "-----> Copying raw frontend to rails app"
set -x
mkdir -p ${js_app_copy}
cp -R ${js_app}/. ${js_app_copy}

ls -laFG ${js_app_copy}/
